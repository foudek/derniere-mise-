<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dernière Mise</title>
<style>
html,body{
  margin:0;
  background:black;
  overflow:hidden;
}
canvas{display:block;}
</style>
</head>
<body>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize",resize);
resize();

let t = 0;
let choice = null;
let timeline = [];
let scene = 0;
let startTime = 0;

/* CAMERA */
function shake(intensity=1.5){
  ctx.translate(
    Math.sin(t*0.08)*intensity,
    Math.cos(t*0.06)*intensity
  );
}

/* TEXT */
function txt(str,y){
  ctx.font="18px monospace";
  ctx.fillStyle="white";
  ctx.fillText(str,40,y);
}

/* DRAWINGS */
function face(emotion){
  const cx = canvas.width/2;
  const cy = canvas.height/2;

  const breath = Math.sin(t*0.03)*3;
  ctx.save();
  ctx.translate(cx,cy);
  ctx.scale(1+breath*0.002,1+breath*0.002);
  ctx.translate(-cx,-cy);

  ctx.strokeStyle="white";
  ctx.lineWidth=1.2;

  // eye
  ctx.beginPath();
  ctx.arc(cx-40,cy,30,Math.PI*0.1,Math.PI*0.9);
  ctx.stroke();

  // eyelid
  let lid = emotion==="shock"?12:emotion==="fear"?6:2;
  ctx.beginPath();
  ctx.moveTo(cx-70,cy);
  ctx.lineTo(cx-10,cy+lid);
  ctx.stroke();

  // mouth
  ctx.beginPath();
  if(emotion==="shock"){
    ctx.arc(cx-40,cy+60,14,0,Math.PI*2);
  }else{
    ctx.moveTo(cx-60,cy+60);
    ctx.lineTo(cx-20,cy+60);
  }
  ctx.stroke();

  ctx.restore();
}

function poker(players){
  ctx.strokeStyle="white";
  ctx.strokeRect(
    canvas.width/2-220,
    canvas.height/2-110,
    440,220
  );
  for(let i=0;i<players;i++){
    ctx.beginPath();
    ctx.arc(
      canvas.width/2-150+i*(300/(players-1||1)),
      canvas.height/2+150,
      20,0,Math.PI*2
    );
    ctx.stroke();
  }
}

function gun(){
  ctx.strokeStyle="white";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,90,0,Math.PI*2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,40,0,Math.PI*2);
  ctx.stroke();
}

/* SCENES */
function intro(){
  txt("TABLE DE POKER. SILENCE.",80);
  txt("Un joueur n'a plus de jetons.",110);
  txt("CLIC GAUCHE : tirer",160);
  txt("CLIC DROIT : donner des jetons",190);
}

function lost(){
  face("shock");
  txt("Il perd la manche.",80);
}

function game(){
  poker(choice==="kill"?3:4);
  txt("Cartes. Jetons. Tension.",80);
}

function end(){
  gun();
  txt("Respiration.",80);
  txt("Décision finale.",110);
}

/* TIMELINE */
function build(){
  timeline = [
    {d:10000, f:intro},
    {d:7000, f:lost},
    {d:30000, f:game},
    {d:7000, f:()=>face("fear")},
    {d:10000, f:end},
    {d:3000, f:()=>{ctx.fillStyle="white";ctx.fillRect(0,0,canvas.width,canvas.height);}}
  ];
}

/* LOOP */
function loop(ts){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.save();
  shake();

  if(timeline[scene]){
    timeline[scene].f();
    if(ts-startTime > timeline[scene].d){
      scene++;
      startTime = ts;
    }
  }

  ctx.restore();
  t++;
  requestAnimationFrame(loop);
}

/* INPUT */
canvas.addEventListener("click",e=>{
  if(choice) return;
  choice = e.clientX < innerWidth/2 ? "kill" : "spare";
  build();
  startTime = performance.now();
});

requestAnimationFrame(loop);
</script>

</body>
</html>
